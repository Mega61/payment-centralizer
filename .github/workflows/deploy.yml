name: Deploy to Production

on:
  workflow_call:
    inputs:
      image-tag:
        description: 'Docker image tag to deploy'
        required: true
        type: string
    secrets:
      GCP_WORKLOAD_IDENTITY_PROVIDER:
        required: true
      GCP_SERVICE_ACCOUNT_EMAIL:
        required: true
      GCP_PROJECT_ID:
        required: true
      GCP_REGION:
        required: true
      GCS_BUCKET_NAME:
        required: false
      GCS_ANNOTATIONS_BUCKET_NAME:
        required: false
  workflow_dispatch:
    inputs:
      image-tag:
        description: 'Docker image tag to deploy (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get existing environment variables
        id: get-env
        run: |
          # Get existing environment variables from the current deployment
          EXISTING_ENV=$(gcloud run services describe payment-centralizer \
            --region="${{ secrets.GCP_REGION }}" \
            --project="${{ secrets.GCP_PROJECT_ID }}" \
            --format='json' | jq -r '.spec.template.spec.containers[0].env // []' | jq -c '.')

          echo "Existing environment variables: ${EXISTING_ENV}"

          # Extract specific values if they exist
          GCS_BUCKET=$(echo "${EXISTING_ENV}" | jq -r '.[] | select(.name=="GCS_BUCKET_NAME") | .value // ""')
          GCS_ANNOTATIONS=$(echo "${EXISTING_ENV}" | jq -r '.[] | select(.name=="GCS_ANNOTATIONS_BUCKET_NAME") | .value // ""')

          echo "gcs_bucket=${GCS_BUCKET}" >> $GITHUB_OUTPUT
          echo "gcs_annotations=${GCS_ANNOTATIONS}" >> $GITHUB_OUTPUT

      - name: Update Cloud Run service
        id: deploy
        env:
          GCS_BUCKET_NAME: ${{ secrets.GCS_BUCKET_NAME || steps.get-env.outputs.gcs_bucket }}
          GCS_ANNOTATIONS_BUCKET_NAME: ${{ secrets.GCS_ANNOTATIONS_BUCKET_NAME || steps.get-env.outputs.gcs_annotations }}
        run: |
          IMAGE_PATH="${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/payment-centralizer/app:${{ inputs.image-tag }}"

          echo "ðŸš€ Deploying image: ${IMAGE_PATH}"
          echo "ðŸ“¦ GCS Bucket: ${GCS_BUCKET_NAME}"
          echo "ðŸ“¦ Annotations Bucket: ${GCS_ANNOTATIONS_BUCKET_NAME}"

          # Update the service with explicit environment variables to ensure they're preserved
          gcloud run services update payment-centralizer \
            --region="${{ secrets.GCP_REGION }}" \
            --project="${{ secrets.GCP_PROJECT_ID }}" \
            --image="${IMAGE_PATH}" \
            --update-env-vars="GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}" \
            --update-env-vars="GCS_BUCKET_NAME=${GCS_BUCKET_NAME}" \
            --update-env-vars="GCS_ANNOTATIONS_BUCKET_NAME=${GCS_ANNOTATIONS_BUCKET_NAME}" \
            --update-env-vars="NODE_ENV=production" \
            --update-env-vars="LOG_LEVEL=info" \
            --update-env-vars="ENABLE_TRACING=true" \
            --update-env-vars="ENABLE_METRICS=true" \
            --quiet

          # Get the service URL
          SERVICE_URL=$(gcloud run services describe payment-centralizer \
            --region="${{ secrets.GCP_REGION }}" \
            --project="${{ secrets.GCP_PROJECT_ID }}" \
            --format='value(status.url)')

          echo "url=${SERVICE_URL}" >> $GITHUB_OUTPUT
          echo "âœ… Deployment successful!"
          echo "ðŸŒ Service URL: ${SERVICE_URL}"

      - name: Verify deployment
        run: |
          echo "â³ Waiting for service to be ready..."
          sleep 15

          # Get service account for authentication
          SA_EMAIL=$(gcloud run services describe payment-centralizer \
            --region="${{ secrets.GCP_REGION }}" \
            --project="${{ secrets.GCP_PROJECT_ID }}" \
            --format='value(spec.template.spec.serviceAccountName)')

          # Get an identity token
          ID_TOKEN=$(gcloud auth print-identity-token --impersonate-service-account="${SA_EMAIL}" 2>/dev/null || echo "")

          # Check health endpoint
          if [ -n "$ID_TOKEN" ]; then
            HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer ${ID_TOKEN}" \
              "${{ steps.deploy.outputs.url }}/health/live")
          else
            # Try without auth if token generation fails
            HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              "${{ steps.deploy.outputs.url }}/health/live")
          fi

          if [ "$HEALTH_STATUS" == "200" ]; then
            echo "âœ… Health check passed (HTTP ${HEALTH_STATUS})"
          else
            echo "âš ï¸  Health check returned HTTP ${HEALTH_STATUS}"
            echo "Note: This might be expected if the service requires authentication"
          fi

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** \`${{ inputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Service URL:** ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region:** ${{ secrets.GCP_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Deployed successfully" >> $GITHUB_STEP_SUMMARY
